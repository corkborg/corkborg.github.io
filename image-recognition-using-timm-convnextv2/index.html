<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>timmのconvnextv2のトレーニング済みモデルを使って画像分析をしてみる - 塩の惑星</title><meta name="description" content="timmとはPyTorch向けのライブラリで、画像認識系の深層学習の実装を用意してくれている感じのライブラリになっています。 対応している手法を見てみると2024年現在ではvit, resnet, swin, convnextなどをサポートしているようです。&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://corkborg.github.io/image-recognition-using-timm-convnextv2/"><link rel="alternate" type="application/atom+xml" href="https://corkborg.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://corkborg.github.io/feed.json"><meta property="og:title" content="timmのconvnextv2のトレーニング済みモデルを使って画像分析をしてみる"><meta property="og:image" content="https://corkborg.github.io/media/posts/29/fish_kingyo2.png"><meta property="og:image:width" content="800"><meta property="og:image:height" content="733"><meta property="og:site_name" content="塩の惑星"><meta property="og:description" content="timmとはPyTorch向けのライブラリで、画像認識系の深層学習の実装を用意してくれている感じのライブラリになっています。 対応している手法を見てみると2024年現在ではvit, resnet, swin, convnextなどをサポートしているようです。&hellip;"><meta property="og:url" content="https://corkborg.github.io/image-recognition-using-timm-convnextv2/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://corkborg.github.io/media/website/icon.ico" type="image/x-icon"><link rel="stylesheet" href="https://corkborg.github.io/assets/css/prism.css?v=b46352844c4922bafa71c2012d20bbac"><link rel="stylesheet" href="https://corkborg.github.io/assets/css/style.css?v=7904a0296d6f5740959fd72eb87143da"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://corkborg.github.io/image-recognition-using-timm-convnextv2/"},"headline":"timmのconvnextv2のトレーニング済みモデルを使って画像分析をしてみる","datePublished":"2024-03-24T16:09","dateModified":"2024-03-25T22:13","image":{"@type":"ImageObject","url":"https://corkborg.github.io/media/posts/29/fish_kingyo2.png","height":733,"width":800},"description":"timmとはPyTorch向けのライブラリで、画像認識系の深層学習の実装を用意してくれている感じのライブラリになっています。 対応している手法を見てみると2024年現在ではvit, resnet, swin, convnextなどをサポートしているようです。&hellip;","author":{"@type":"Person","name":"ミズソバ","url":"https://corkborg.github.io/authors/mizusoba/"},"publisher":{"@type":"Organization","name":"ミズソバ","logo":{"@type":"ImageObject","url":"https://corkborg.github.io/media/website/logo2.png","height":344,"width":1000}}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8CYBCM4RJ"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y8CYBCM4RJ');</script></head><body><header><div id="header-upper"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div><div><nav class="menu-navbar"><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav></div></header><div id="main-wrapper-with-sidebar"><main><article class="post-only"><header><h1>timmのconvnextv2のトレーニング済みモデルを使って画像分析をしてみる</h1><div class="modified-time">公開日: <time datetime="2024-03-24T16:09">2024-03-24 </time><span id="post-tags"><span class="post-tag"><a href="https://corkborg.github.io/tags/image-recognition/">画像認識</a></span></span></div></header><figure id="featured-image"><img src="https://corkborg.github.io/media/posts/29/fish_kingyo2.png" srcset="https://corkborg.github.io/media/posts/29/responsive/fish_kingyo2-xs.png 300w, https://corkborg.github.io/media/posts/29/responsive/fish_kingyo2-sm.png 480w, https://corkborg.github.io/media/posts/29/responsive/fish_kingyo2-md.png 749w, https://corkborg.github.io/media/posts/29/responsive/fish_kingyo2-xl.png 1200w" sizes="(max-width: 1200px) 100vw, 1200px" loading="eager" height="733" width="800" alt=""><figcaption>この画像は85.7%金魚だと判定されました</figcaption></figure><div id="post-entry"><p><a href="https://timm.fast.ai/" target="_blank" rel="noopener noreferrer">timm</a>とはPyTorch向けのライブラリで、画像認識系の深層学習の実装を用意してくれている感じのライブラリになっています。</p><p>対応している手法を見てみると2024年現在ではvit, resnet, swin, convnextなどをサポートしているようです。</p><p>主にtimmは新たにモデルをトレーニングして作成する際に使うと思うのですが、すでにトレーニング済みのモデルが用意されていて試しにそれを使うこともできます。</p><p>個人的にtimmの学習済みモデルをfine-tuning（微調整）して見たいと思ったので、とりあえずモデルを動かしてみることにしました。</p><h2>ConvNeXt V2</h2><p>今回使っているConvNeXT V2という手法は、昔から存在するCNNという画像認識手法を活用した2022年に提案された新しい手法です。画像認識の分野では新しいTransformer系よりも精度が良いようです（2022年くらいでは）。</p><p>ConvNeXtはCNN系なので精度比でモデルサイズが小さくて済むようです。そのためメモリにも優しいと思われます。</p><p>手法の技術的な詳細はこれらのサイトに書いてありますが筆者はあまり理解していません。<br><a href="https://arxiv.org/abs/2301.00808">https://arxiv.org/abs/2301.00808</a><br><a href="https://arxiv.org/abs/2201.03545" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2201.03545</a></p><h2>画像認識をしてみる</h2><p>まずPythonに必要なものをインストールします。</p><pre class="language-bash"><code>pip install torch timm pillow torchvision</code></pre><p>学習済みモデルはImageNet-1kというデータセットを使っているようなので、ラベルの情報が必要です。こちらにImageNet-1kのラベルをまとめてくれている人がいるのでダウンロードしてlabels.pyという名前に変更します。<br><a href="https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a" target="_blank" rel="noopener noreferrer">https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a</a></p><p>適当なPythonソースコードを作成します。</p><pre class="language-python"><code>import sys
from itertools import zip_longest

import timm
import torch
from PIL import Image
from timm.data import resolve_data_config
from timm.data.transforms_factory import create_transform


# 下記からダウンロードしたラベルをlabels.pyとして保存して使用する
# https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a
from labels import labels

model = timm.create_model('convnextv2_tiny.fcmae', pretrained=True)
# model = timm.create_model("convnextv2_huge.fcmae_ft_in22k_in1k_512", pretrained=True)
model.eval()

# モデル向けに画像を変換してくれる関数を作成
transform = create_transform(**resolve_data_config(model.pretrained_cfg, model=model), is_training=False)

# 変換する
image = Image.open(sys.argv[1]).convert('RGB')
image = transform(image).unsqueeze(0)

# 推論
out = model(image)

# 予想された確率の合計が１になるように変換
probabilities = out.softmax(dim=1)

# 上位５つの推論結果を取得
top5_probabilities, top5_class_indices = torch.topk(probabilities * 100, k=5)

for c, v in zip_longest(top5_class_indices[0], top5_probabilities[0]):
    label_id = c.item()  # ラベルのid
    label_name = labels[label_id]  # ラベルの英名
    label_probability = v.item()  # 確率
    print(label_id, label_name, label_probability)</code></pre><p>適当な画像で推論してみます。</p><pre class="language-bash"><code>python predict.py image.jpg</code></pre><p>ImageNet-1kは小さいデータセットなので動物などわかりやすい画像で試してみるのが良さそうです。</p><figure class="post__image post__image--center"><img loading="lazy" src="https://corkborg.github.io/media/posts/29/sukurinsiyotuto-2024-03-24-16.40.09.png" alt="ImageNet-1K dataset records" width="523" height="300" sizes="(max-width: 1200px) 100vw, 1200px" srcset="https://corkborg.github.io/media/posts/29/responsive/sukurinsiyotuto-2024-03-24-16.40.09-xs.png 300w, https://corkborg.github.io/media/posts/29/responsive/sukurinsiyotuto-2024-03-24-16.40.09-sm.png 480w, https://corkborg.github.io/media/posts/29/responsive/sukurinsiyotuto-2024-03-24-16.40.09-md.png 749w, https://corkborg.github.io/media/posts/29/responsive/sukurinsiyotuto-2024-03-24-16.40.09-xl.png 1200w"></figure><p>ただ、めちゃめちゃな結果が返ってくると思います。試しに使用した。</p><div><div>convnextv2_tiny.fcmaeという学習済みモデルが非力だからです。</div><div> </div><div>コメントを解除して大きめで精度の良いモデルを有効化します（2GBくらいあります）。</div><div><pre class="language-bash"><code># model = timm.create_model('convnextv2_tiny.fcmae', pretrained=True)
model = timm.create_model("convnextv2_huge.fcmae_ft_in22k_in1k_512", pretrained=True)</code></pre></div></div><p>金魚の画像を投入してみた結果です。</p><pre class="language-bash"><code>1 goldfish, Carassius auratus 85.73846435546875
392 rock beauty, Holocanthus tricolor 8.172449111938477
393 anemone fish 0.17695628106594086
973 coral reef 0.15994583070278168</code></pre><p>うまく推論できていそうです。（金魚は学名だとCarassius auratusと言うのか…）</p><h2>timmの詳細</h2><p>timmの使い方はここに書いてあります。<br><a href="https://huggingface.co/docs/hub/timm" target="_blank" rel="noopener noreferrer">https://huggingface.co/docs/hub/timm</a></p><p>timmの推論済みConvNeXTモデルの詳細は下記に書いてあります。<br><a href="https://huggingface.co/timm/convnextv2_tiny.fcmae" target="_blank" rel="noopener noreferrer">https://huggingface.co/timm/convnextv2_tiny.fcmae</a></p><p> </p></div><div class="modified-time">更新日: <time datetime="2024-03-25T22:13">2024-03-25</time></div><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fcorkborg.github.io%2Fimage-recognition-using-timm-convnextv2%2F" class="js-share facebook" title="Share with Facebook" rel="nofollow noopener noreferrer" aria-label="Share with Facebook"><svg class="u-icon"><use xlink:href="https://corkborg.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fcorkborg.github.io%2Fimage-recognition-using-timm-convnextv2%2F&amp;via=%E5%A1%A9%E3%81%AE%E6%83%91%E6%98%9F&amp;text=timm%E3%81%AEconvnextv2%E3%81%AE%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E7%94%BB%E5%83%8F%E5%88%86%E6%9E%90%E3%82%92%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B" class="js-share twitter" title="Share with Twitter" rel="nofollow noopener noreferrer" target="_blank" aria-label="Share with Twitter"><svg class="u-icon"><use xlink:href="https://corkborg.github.io/assets/svg/svg-map.svg#twitter"/></svg></a></div><nav id="post-navigation"><div class="post-navigation-link"><a href="https://corkborg.github.io/sign-contract-bikepark-81989-remotely/" rel="prev">&larr; 前の記事: バイクパークでバイク駐車場の契約を完全リモートで行った話</a></div><div class="post-navigation-link"><a href="https://corkborg.github.io/spirogyra-measures-in-aquarium/" rel="next">次の記事: 硬いアオミドロ（糸状ゴケ）を対策する方法について個人的な経験から解説 &rarr;</a></div></nav></article></main><aside><section><h3>Featured posts</h3><ol class="featured-posts__list"><li><a href="https://corkborg.github.io/created-kanji-to-time/" class="invert">日本語や漢字の日付をPythonのdatetimeに変換するライブラリを作った</a></li><li><a href="https://corkborg.github.io/publii-is-good-website-generator/" class="invert">使いやすいエディターで静的サイト生成できるPubliiがおすすめな話</a></li><li><a href="https://corkborg.github.io/energy-saving-battle-gaming-pc-vs-apple-silicon-mac/" class="invert">ゲーミングPCは電気代が高い！電気代が安いApple Silicon Macのゲームでの省電力能力を検証</a></li><li><a href="https://corkborg.github.io/steam-games-support-apple-silicon/" class="invert">Apple Silicon Macで遊べるゲームリスト. M1 Macで検証してみた</a></li><li><a href="https://corkborg.github.io/arma3-support-apple-silicon-m1-macbook-air/" class="invert">Arma3はApple Siliconにネイティブ対応している？M1 MacBook Airで試してみた</a></li></ol></section></aside></div><footer><nav class="menu-navbar"><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav><div id="footer-lower"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div></footer><script defer="defer" src="https://corkborg.github.io/assets/js/prism.js?v=2730b884bcd782a7b6ffd13dcb5504c0"></script><script async src="https://corkborg.github.io/assets/js/scripts.js?v=3733efd39cd6c799b95c8fcb96993840"></script></body></html>