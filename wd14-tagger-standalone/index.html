<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>画像にタグ付けするWD14 taggerを単体で動かす - 塩の惑星</title><meta name="description" content="stable-diffusion-webui-wd14-taggerというものはSmilingWolfという方が作ったモデルを使ったwebui向けのプラグインで、使うとイラストの中に書かれた要素を分析して出力することができます。 イラストの要素分析は生成AI向けにLoraを作る時などいろんな用途で使える便利な機能でwebui抜きに動作させたかったので単体で動かしてみました。 原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、stable-diffusion-webui-wd14-taggerの方から動作に必要なコードだけを抜き出して動かしてみました。 （機械学習まわりがTensorflowよりもPytorchのほうが取り扱いやすかったのもあります） 今回のために作ったコードは下記です。&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://corkborg.github.io/wd14-tagger-standalone/"><link rel="alternate" type="application/atom+xml" href="https://corkborg.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://corkborg.github.io/feed.json"><meta property="og:title" content="画像にタグ付けするWD14 taggerを単体で動かす"><meta property="og:image" content="https://corkborg.github.io/media/website/logo2.png"><meta property="og:image:width" content="1000"><meta property="og:image:height" content="344"><meta property="og:site_name" content="塩の惑星"><meta property="og:description" content="stable-diffusion-webui-wd14-taggerというものはSmilingWolfという方が作ったモデルを使ったwebui向けのプラグインで、使うとイラストの中に書かれた要素を分析して出力することができます。 イラストの要素分析は生成AI向けにLoraを作る時などいろんな用途で使える便利な機能でwebui抜きに動作させたかったので単体で動かしてみました。 原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、stable-diffusion-webui-wd14-taggerの方から動作に必要なコードだけを抜き出して動かしてみました。 （機械学習まわりがTensorflowよりもPytorchのほうが取り扱いやすかったのもあります） 今回のために作ったコードは下記です。&hellip;"><meta property="og:url" content="https://corkborg.github.io/wd14-tagger-standalone/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://corkborg.github.io/media/website/icon.ico" type="image/x-icon"><link rel="stylesheet" href="https://corkborg.github.io/assets/css/style.css?v=9112cb2d00e0f768a61601e2050c3bdd"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://corkborg.github.io/wd14-tagger-standalone/"},"headline":"画像にタグ付けするWD14 taggerを単体で動かす","datePublished":"2023-10-01T20:00","dateModified":"2023-11-25T18:07","image":{"@type":"ImageObject","url":"https://corkborg.github.io/media/website/logo2.png","height":344,"width":1000},"description":"stable-diffusion-webui-wd14-taggerというものはSmilingWolfという方が作ったモデルを使ったwebui向けのプラグインで、使うとイラストの中に書かれた要素を分析して出力することができます。 イラストの要素分析は生成AI向けにLoraを作る時などいろんな用途で使える便利な機能でwebui抜きに動作させたかったので単体で動かしてみました。 原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、stable-diffusion-webui-wd14-taggerの方から動作に必要なコードだけを抜き出して動かしてみました。 （機械学習まわりがTensorflowよりもPytorchのほうが取り扱いやすかったのもあります） 今回のために作ったコードは下記です。&hellip;","author":{"@type":"Person","name":"ミズソバ","url":"https://corkborg.github.io/authors/mizusoba/"},"publisher":{"@type":"Organization","name":"ミズソバ","logo":{"@type":"ImageObject","url":"https://corkborg.github.io/media/website/logo2.png","height":344,"width":1000}}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8CYBCM4RJ"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y8CYBCM4RJ');</script></head><body><header><div id="header-upper"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div><div><nav><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav></div></header><div id="main-wrapper-for-post"><div id="main-wrapper-for-post-left"></div><main><article class="post-only"><header><h1>画像にタグ付けするWD14 taggerを単体で動かす</h1><div>Created on: <time datetime="2023-10-01T20:00">2023-10-01 </time><span id="post-tags"><span class="post-tag"><a href="https://corkborg.github.io/tags/sheng-cheng-ai/">生成AI</a></span></span></div></header><div id="post-entry"><p><a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" title="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" target="_blank" rel="noopener noreferrer">stable-diffusion-webui-wd14-tagger</a>というものはSmilingWolfという方が作ったモデルを使ったwebui向けのプラグインで、使うとイラストの中に書かれた要素を分析して出力することができます。</p><p>イラストの要素分析は生成AI向けにLoraを作る時などいろんな用途で使える便利な機能でwebui抜きに動作させたかったので単体で動かしてみました。</p><h2>動かし方</h2><p>原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、<a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" title="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" target="_blank" rel="noopener noreferrer">stable-diffusion-webui-wd14-tagger</a>の方から動作に必要なコードだけを抜き出して動かしてみました。<br>（機械学習まわりがTensorflowよりもPytorchのほうが取り扱いやすかったのもあります）</p><p>今回のために作ったコードは下記です。<br>簡素なコードになっているのでコードを修正することで機能追加することができると思います。<br><a href="https://github.com/corkborg/wd14-tagger-standalone" target="_blank" rel="noopener noreferrer">https://github.com/corkborg/wd14-tagger-standalone</a></p><p>Windowsでの動かし方は下記です（開発時はMacを使っていたのでそっちでも動きます）<br>Python3やgitコマンドが事前にインストールされている必要があります。</p><pre>git clone <a href="https://github.com/corkborg/wd14-tagger-standalone.git">https://github.com/corkborg/wd14-tagger-standalone.git</a><br>cd wd14-tagger-standalone<br><br># 必要なライブラリのインストール<br>python3 -m venv venv<br>venv/Scripts/activate<br>pip install -r requirements.txt<br><br># ヘルプの確認<br>python3 run.py --help<br><br># シングルファイルの推論<br>python3 run.py --file path¥image.jpg<br><br># 複数ファイルでの推論<br>python3 run.py --dir path</pre><h2>動作確認</h2><p>こちらのサイトさんからずんだモンさんの画像をダウンロードしました。<br><a href="https://zunko.jp/" target="_blank" rel="noopener noreferrer">https://zunko.jp/</a></p><p><img loading="lazy" src="https://zunko.jp/images/chara_zm.png" width="214" height="302" data-is-external-image="true"></p><p>こんな感じになりました。</p><pre>&gt;  venv/bin/python run.py --file chara_zm.png<br>1girl, green_hair, solo, short_sleeves, green_footwear, shirt, green_shorts, white_shirt, smile, full_body, suspenders, shorts, puffy_sleeves, open_mouth, puffy_shorts, white_background, looking_at_viewer, puffy_short_sleeves, standing, orange_eyes, :d, simple_background, yellow_eyes, suspender_shorts, boots</pre><p><a href="#INTERNAL_LINK#/post/null"></a>単体で使うことができました。</p><h2>一気に画像にタグ付けをする</h2><p>多くの場合一枚一枚画像にタグ付けせずに一気に複数枚画像にタグ付けすると思います。</p><p>下記の例ではgazou_fileディレクトリ内の画像すべてに対してタグの予想をおこなって画像ファイル名 + ext(拡張子)でキャプションファイルを作っています。</p><pre>python3 run.py --dir ./gazou_file --ext .txt</pre><h2>その他</h2><h3>モデルの変更方法</h3><p>run.pyで初期化しているWaifuDiffusionInterrogatorにhuggingface上のモデル名を渡すと自動でダウンロードされます。そのためここを書き換える事で任意のモデルを使用する事ができます。</p><pre>interrogator = WaifuDiffusionInterrogator(<br>    'wd14-convnextv2-v2',<br>    repo_id='SmilingWolf/wd-v1-4-convnextv2-tagger-v2',<br>    revision='v2.0'<br>)</pre><p>ここらへんのコードを参考にすると良いと思います。<br><a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger/blob/master/tagger/utils.py" target="_blank" rel="noopener noreferrer">https://github.com/picobyte/stable-diffusion-webui-wd14-tagger/blob/master/tagger/utils.py</a></p><p>現在はより高性能なモデルも存在するようです。<br><a href="https://note.com/den2_nova/n/ndd9e2570572b" target="_blank" rel="noopener noreferrer">https://note.com/den2_nova/n/ndd9e2570572b</a></p><h3>スレッショルドなど</h3><p>デフォルトではwebuiと同じく一律35%以上の一致率のタグだけを残しています。<br>これはコマンドライン引数で変更することができます。</p><div><pre># 25%に変更<br>python3 run.py --threthold 0.25 --file image.jpg</pre></div><h3>高速化</h3><p>今回は用意したコードはCPU上で推論処理を動かしています。<br>m1 macでも一瞬で返ってくるのでそんなに問題ないとは思っているのですが、もっと早く動かしたい場合はGPUなどを使うように改造したほうが良いかもしれないです。</p><p> </p><p> </p></div>Updated on: <time datetime="2023-11-25T18:07">2023-11-25</time><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fcorkborg.github.io%2Fwd14-tagger-standalone%2F" class="js-share facebook" title="Share with Facebook" rel="nofollow noopener noreferrer" aria-label="Share with Facebook"><svg class="u-icon"><use xlink:href="https://corkborg.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fcorkborg.github.io%2Fwd14-tagger-standalone%2F&amp;via=%E5%A1%A9%E3%81%AE%E6%83%91%E6%98%9F&amp;text=%E7%94%BB%E5%83%8F%E3%81%AB%E3%82%BF%E3%82%B0%E4%BB%98%E3%81%91%E3%81%99%E3%82%8BWD14%20tagger%E3%82%92%E5%8D%98%E4%BD%93%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99" class="js-share twitter" title="Share with Twitter" rel="nofollow noopener noreferrer" target="_blank" aria-label="Share with Twitter"><svg class="u-icon"><use xlink:href="https://corkborg.github.io/assets/svg/svg-map.svg#twitter"/></svg></a></div><nav id="post-navigation"><div class="post-navigation-link"><a href="https://corkborg.github.io/steam-games-support-apple-silicon/" rel="prev">&larr; Previous: Apple Silicon Macで遊べるゲームリスト. M1 Macで検証してみた</a></div><div class="post-navigation-link"><a href="https://corkborg.github.io/salvia-maru-difference-3f-4f/" rel="next">Next: 伊豆大島 さるびあ丸 特2等室の3F、4Fの違いについて &rarr;</a></div></nav></article></main><aside><section><h3>Featured posts</h3><ol class="featured-posts__list"><li><a href="https://corkborg.github.io/energy-saving-battle-gaming-pc-vs-apple-silicon-mac/" class="invert">ゲーミングPCは電気代が高い？ゲームでのApple Silicon Macの実力を測る</a></li><li><a href="https://corkborg.github.io/atok-vs-google-japanese-input/" class="invert">ATOK日本語入力のクラウド機能ではGoogle日本語入力に勝てなかった</a></li><li><a href="https://corkborg.github.io/steam-games-support-apple-silicon/" class="invert">Apple Silicon Macで遊べるゲームリスト. M1 Macで検証してみた</a></li><li><a href="https://corkborg.github.io/arma3-support-apple-silicon-m1-macbook-air/" class="invert">Arma3はApple Siliconにネイティブ対応している？M1 MacBook Airで試してみた</a></li></ol></section></aside></div><footer><nav><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav><div id="footer-lower"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div></footer><script async src="https://corkborg.github.io/assets/js/scripts.js?v=3733efd39cd6c799b95c8fcb96993840"></script></body></html>