<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>画像にタグ付けするWD14 taggerを単体で動かす - 塩の惑星</title><meta name="description" content="stable-diffusion-webui-wd14-taggerというものはSmilingWolfという方が作った使うとイラストの中に書かれた要素を分析してテキストで出力するモデルをwebuiで動かせるようにしたプラグインです。 イラストの要素分析は生成AI向けにLoraを作る際やいろんな用途で使える便利な機能でwebui抜きに動作捺せたかったので単体で動かしてみました。 原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、stable-diffusion-webui-wd14-taggerの方から動作に必要なコードだけを抜き出して動かしてみました。 今回のために作ったコードは下記です。 作りがだいぶ雑なのでなにか不備があれば内容に手を加えてもらうのが良いと思います。&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://corkborg.github.io/wd14-tagger-standalone/"><link rel="alternate" type="application/atom+xml" href="https://corkborg.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://corkborg.github.io/feed.json"><meta property="og:title" content="画像にタグ付けするWD14 taggerを単体で動かす"><meta property="og:image" content="https://corkborg.github.io/media/website/logo2.png"><meta property="og:image:width" content="1000"><meta property="og:image:height" content="344"><meta property="og:site_name" content="塩の惑星"><meta property="og:description" content="stable-diffusion-webui-wd14-taggerというものはSmilingWolfという方が作った使うとイラストの中に書かれた要素を分析してテキストで出力するモデルをwebuiで動かせるようにしたプラグインです。 イラストの要素分析は生成AI向けにLoraを作る際やいろんな用途で使える便利な機能でwebui抜きに動作捺せたかったので単体で動かしてみました。 原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、stable-diffusion-webui-wd14-taggerの方から動作に必要なコードだけを抜き出して動かしてみました。 今回のために作ったコードは下記です。 作りがだいぶ雑なのでなにか不備があれば内容に手を加えてもらうのが良いと思います。&hellip;"><meta property="og:url" content="https://corkborg.github.io/wd14-tagger-standalone/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://corkborg.github.io/media/website/icon.ico" type="image/x-icon"><link rel="stylesheet" href="https://corkborg.github.io/assets/css/style.css?v=29966bdb14b21fdc84cb5f965e20de85"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://corkborg.github.io/wd14-tagger-standalone/"},"headline":"画像にタグ付けするWD14 taggerを単体で動かす","datePublished":"2023-10-01T20:00","dateModified":"2023-10-15T00:39","image":{"@type":"ImageObject","url":"https://corkborg.github.io/media/website/logo2.png","height":344,"width":1000},"description":"stable-diffusion-webui-wd14-taggerというものはSmilingWolfという方が作った使うとイラストの中に書かれた要素を分析してテキストで出力するモデルをwebuiで動かせるようにしたプラグインです。 イラストの要素分析は生成AI向けにLoraを作る際やいろんな用途で使える便利な機能でwebui抜きに動作捺せたかったので単体で動かしてみました。 原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、stable-diffusion-webui-wd14-taggerの方から動作に必要なコードだけを抜き出して動かしてみました。 今回のために作ったコードは下記です。 作りがだいぶ雑なのでなにか不備があれば内容に手を加えてもらうのが良いと思います。&hellip;","author":{"@type":"Person","name":"ミズソバ","url":"https://corkborg.github.io/authors/mizusoba/"},"publisher":{"@type":"Organization","name":"ミズソバ","logo":{"@type":"ImageObject","url":"https://corkborg.github.io/media/website/logo2.png","height":344,"width":1000}}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8CYBCM4RJ"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y8CYBCM4RJ');</script></head><body><header><div id="header-upper"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div><div><nav><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav></div></header><div id="main-wrapper-for-post"><div id="main-wrapper-for-post-left"></div><main><article class="post-only"><header><h1>画像にタグ付けするWD14 taggerを単体で動かす</h1><div><time datetime="2023-10-01T20:00">2023-10-01 </time><span id="post-tags"><span class="post-tag"><a href="https://corkborg.github.io/tags/sheng-cheng-ai/">生成AI</a></span></span></div></header><div id="post-entry"><p> </p><p><a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" title="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" target="_blank" rel="noopener noreferrer">stable-diffusion-webui-wd14-tagger</a>というものはSmilingWolfという方が作った使うとイラストの中に書かれた要素を分析してテキストで出力するモデルをwebuiで動かせるようにしたプラグインです。<br>イラストの要素分析は生成AI向けにLoraを作る際やいろんな用途で使える便利な機能でwebui抜きに動作捺せたかったので単体で動かしてみました。</p><h2>動かし方</h2><p>原理的には元のモデル作者であるSmilingWolfさんの学習スクリプトを参考にすれば単体で動かせるはずですが見てもあまり分からなかったので、<a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" title="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" target="_blank" rel="noopener noreferrer">stable-diffusion-webui-wd14-tagger</a>の方から動作に必要なコードだけを抜き出して動かしてみました。</p><p>今回のために作ったコードは下記です。<br>作りがだいぶ雑なのでなにか不備があれば内容に手を加えてもらうのが良いと思います。<br><a href="https://github.com/corkborg/wd14-tagger-standalone" target="_blank" rel="noopener noreferrer">https://github.com/corkborg/wd14-tagger-standalone</a></p><p>Windowsでの動かし方は下記です（開発時はMacを使っていたのでそっちでも動きます）<br>Python3やgitコマンドが事前にインストールされている必要があります。</p><pre>git clone <a href="https://github.com/corkborg/wd14-tagger-standalone.git">https://github.com/corkborg/wd14-tagger-standalone.git</a><br>cd wd14-tagger-standalone<br><br># 必要なライブラリのインストール<br>python3 -m venv venv<br>venv/Scripts/activate<br>pip install -r requirements.txt<br><br># ヘルプの確認<br>python3 run.py --help<br><br># シングルファイルの推論<br>python3 run.py --file path¥image.jpg<br><br># 複数ファイルでの推論<br>python3 run.py --dir path</pre><h2>動作確認</h2><p>こちらのサイトさんからずんだモンさんの画像をダウンロードしました。<br><a href="#INTERNAL_LINK#/post/null">https://zunko.jp/</a></p><p><img loading="lazy" src="https://zunko.jp/images/chara_zm.png" width="214" height="302" data-is-external-image="true"></p><p>こんな感じになりました。</p><pre>&gt;  venv/bin/python run.py --file chara_zm.png<br>1girl 0.9774133563041687<br>green_hair 0.9474836587905884<br>solo 0.9398633241653442<br>short_sleeves 0.8664116859436035<br>green_footwear 0.8559225797653198<br>shirt 0.8352453112602234<br>green_shorts 0.8336561918258667<br>white_shirt 0.8312864899635315<br>smile 0.7939807176589966<br>full_body 0.7641559839248657<br>suspenders 0.7595807313919067<br>shorts 0.7565829753875732<br>puffy_sleeves 0.7426384091377258<br>open_mouth 0.7329846024513245<br>puffy_shorts 0.7179946303367615<br>white_background 0.6777039170265198<br>looking_at_viewer 0.6681153774261475<br>puffy_short_sleeves 0.6424634456634521<br>standing 0.6409584283828735<br>orange_eyes 0.6313596963882446<br>:d 0.6026382446289062<br>simple_background 0.4987953007221222<br>yellow_eyes 0.4950907528400421<br>suspender_shorts 0.4660169184207916<br>boots 0.3825642764568329<br>{'general': 0.7158641219139099, 'sensitive': 0.3011893630027771, 'questionable': 0.0005881786346435547, 'explicit': 0.00012153387069702148}</pre><p><a href="#INTERNAL_LINK#/post/null"></a>単体で使うことができました。</p><h2>その他</h2><h3>モデルの変更方法</h3><p>run.pyで初期化しているWaifuDiffusionInterrogatorにhuggingface上のモデル名を渡すと自動でダウンロードされます。そのためここを書き換える事で任意のモデルを使用する事ができます。</p><pre>interrogator = WaifuDiffusionInterrogator(<br>    'wd14-convnextv2-v2',<br>    repo_id='SmilingWolf/wd-v1-4-convnextv2-tagger-v2',<br>    revision='v2.0'<br>)</pre><p>ここらへんのコードを参考にすると良いと思います。<br><a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger/blob/master/tagger/utils.py" target="_blank" rel="noopener noreferrer">https://github.com/picobyte/stable-diffusion-webui-wd14-tagger/blob/master/tagger/utils.py</a></p><p>現在はより高性能なモデルも存在するようです。<br><a href="https://note.com/den2_nova/n/ndd9e2570572b" target="_blank" rel="noopener noreferrer">https://note.com/den2_nova/n/ndd9e2570572b</a></p><h3>スレッショルドなど</h3><p>デフォルトでは一律35%以上の一致率のタグだけを残しています。<br>これはコマンドライン引数で変更することができます。</p><div><pre># 25%に変更<br>python3 run.py --threthold 0.25 --file image.jpg</pre></div><h3>高速化</h3><p>今回は用意したコードは適当なのでCPU上で推論処理を動かしています。<br>m1 macでは一瞬で返ってくるのでそんなに問題ないとは思っているのですが、もっと早く動かしたい場合はGPUなどを使うように改造したほうが良いかもしれないです。</p><p> </p><p> </p></div>Updated on: <time datetime="2023-10-15T00:39">2023-10-15</time><nav id="post-navigation"><div class="post-navigation-link"><a href="https://corkborg.github.io/steam-games-support-apple-silicon/" rel="prev">&larr; Previous: Apple Silicon Macに対応しているSteamのゲーム. M1 MacBook Airで検証してみた</a></div></nav></article></main><aside><section><h3>Selected posts</h3><ul><li><a href="https://corkborg.github.io/factorio-support-applesilicon/">FactorioがApple siliconに対応したようなのでM1 Macで遊んでみた</a></li><li><a href="https://corkborg.github.io/how-to-create-multiplayer-server-project-zomboid/">Project ZomboidのサーバをUbuntuとDockerで立てる方法</a></li><li><a href="https://corkborg.github.io/arma3-support-apple-silicon-m1-macbook-air/">Arma3はApple Siliconにネイティブ対応している？M1 MacBook Airで試してみた</a></li></ul></section></aside></div><footer><nav><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav><div id="footer-lower"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div></footer><script async src="https://corkborg.github.io/assets/js/scripts.js?v=3733efd39cd6c799b95c8fcb96993840"></script></body></html>