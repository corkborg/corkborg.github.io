<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>画像にタグ付けするWD14 taggerをwebui無しで動かす - 塩の惑星</title><meta name="description" content="stable-diffusion-webui-wd14-taggerはStable DiffusionでLoraを作成する際の定番プラグインで、イラストの中に書かれた要素を分析してタグとして出力することができます。 このプラグインはStable Diffusion webui向けのものなので使用するにはwebuiを起動する必要があります。&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://corkborg.github.io/wd14-tagger-standalone/"><link rel="alternate" type="application/atom+xml" href="https://corkborg.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://corkborg.github.io/feed.json"><meta property="og:title" content="画像にタグ付けするWD14 taggerをwebui無しで動かす"><meta property="og:image" content="https://corkborg.github.io/media/website/logo2.png"><meta property="og:image:width" content="1000"><meta property="og:image:height" content="344"><meta property="og:site_name" content="塩の惑星"><meta property="og:description" content="stable-diffusion-webui-wd14-taggerはStable DiffusionでLoraを作成する際の定番プラグインで、イラストの中に書かれた要素を分析してタグとして出力することができます。 このプラグインはStable Diffusion webui向けのものなので使用するにはwebuiを起動する必要があります。&hellip;"><meta property="og:url" content="https://corkborg.github.io/wd14-tagger-standalone/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://corkborg.github.io/media/website/icon.ico" type="image/x-icon"><link rel="stylesheet" href="https://corkborg.github.io/assets/css/prism.css?v=b46352844c4922bafa71c2012d20bbac"><link rel="stylesheet" href="https://corkborg.github.io/assets/css/style.css?v=236e5621710cafee8379081bb5f56a22"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://corkborg.github.io/wd14-tagger-standalone/"},"headline":"画像にタグ付けするWD14 taggerをwebui無しで動かす","datePublished":"2023-10-01T20:00","dateModified":"2024-07-09T13:26","image":{"@type":"ImageObject","url":"https://corkborg.github.io/media/website/logo2.png","height":344,"width":1000},"description":"stable-diffusion-webui-wd14-taggerはStable DiffusionでLoraを作成する際の定番プラグインで、イラストの中に書かれた要素を分析してタグとして出力することができます。 このプラグインはStable Diffusion webui向けのものなので使用するにはwebuiを起動する必要があります。&hellip;","author":{"@type":"Person","name":"ミズソバ","url":"https://corkborg.github.io/authors/mizusoba/"},"publisher":{"@type":"Organization","name":"ミズソバ","logo":{"@type":"ImageObject","url":"https://corkborg.github.io/media/website/logo2.png","height":344,"width":1000}}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8CYBCM4RJ"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y8CYBCM4RJ');</script></head><body><header><div id="header-upper"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div><div><nav class="menu-navbar"><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav></div></header><div id="main-wrapper-with-sidebar"><main><article class="post-only"><header><h1>画像にタグ付けするWD14 taggerをwebui無しで動かす</h1><div class="modified-time">公開日: <time datetime="2023-10-01T20:00">2023-10-01 </time><span id="post-tags"><span class="post-tag"><a href="https://corkborg.github.io/tags/puroguramingu/">プログラミング</a></span></span></div></header><div id="post-entry"><p><a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" title="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" target="_blank" rel="noopener noreferrer">stable-diffusion-webui-wd14-tagger</a>はStable DiffusionでLoraを作成する際の定番プラグインで、イラストの中に書かれた要素を分析してタグとして出力することができます。</p><p>このプラグインはStable Diffusion webui向けのものなので使用するにはwebuiを起動する必要があります。<br>ただ、タグをつける作業ではwebuiがなくても問題ない場合も多いので単体で動かすコマンドを用意しました。</p><h2>コード</h2><p>作ったコードは下記です。Python3があれば動きます。<br><a href="https://github.com/corkborg/wd14-tagger-standalone" target="_blank" rel="noopener noreferrer">https://github.com/corkborg/wd14-tagger-standalone</a></p><p><a href="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" title="https://github.com/picobyte/stable-diffusion-webui-wd14-tagger" target="_blank" rel="noopener noreferrer"></a>webui-wd14-taggerの方から動作に必要なコードだけを抜き出して作りました。</p><h2>動かし方</h2><p>Windowsでの動かし方を紹介します。（Macで開発しているのでそっちでも動きます）</p><p>Python3やgitなどがWindowsに事前にインストールされている必要があります。</p><h3>環境セットアップ</h3><p>まず、WindowsにgitとPython3をインストールします。<br>gitのインストール方法は下記が参考になります。<br><a href="https://qiita.com/T-H9703EnAc/items/4fbe6593d42f9a844b1c" target="_blank" rel="noopener noreferrer">https://qiita.com/T-H9703EnAc/items/4fbe6593d42f9a844b1c</a></p><p>Pythonのインストールは下記のMicrosoft公式ストアからダウンロードしたファイルを実行することで行えます。<br><a rel="nofollow noopener" target="_blank" href="https://apps.microsoft.com/detail/9ncvdn91xzqp">https://apps.microsoft.com/detail/9ncvdn91xzqp</a></p><h2>プロジェクトの展開</h2><p>適当にディレクトリを作成します。そのなかでshiftキーを押しながら右クリックを押します。<br>コンテキストメニューの中に「PowerShell ウィンドウをここで開く」というメニューがあるのでそれを押します。</p><figure class="post__image post__image--center"><img loading="lazy" src="https://corkborg.github.io/media/posts/11/unnamed.png" alt="" width="409" height="233" sizes="(max-width: 1200px) 100vw, 1200px" srcset="https://corkborg.github.io/media/posts/11/responsive/unnamed-xs.png 300w, https://corkborg.github.io/media/posts/11/responsive/unnamed-sm.png 480w, https://corkborg.github.io/media/posts/11/responsive/unnamed-md.png 749w, https://corkborg.github.io/media/posts/11/responsive/unnamed-xl.png 1200w"></figure><p>PowerShell上では下記のようなコマンドを１行づつ入力します。</p><pre class="language-batch"><code># コードの展開
git clone https://github.com/corkborg/wd14-tagger-standalone.git
cd wd14-tagger-standalone

# 必要なライブラリのインストール
python -m venv venv
venv/Scripts/activate
pip install -r requirements.txt

# コマンド使用前にはactivateを忘れずに
venv/Scripts/activate 

# ヘルプの確認
python run.py --help

# シングルファイルの推論
python run.py --file path¥image.jpg

# ディレクトリ内のファイルを一括推論
python run.py --dir path</code></pre><h2>動作確認</h2><p>こちらのサイトさんからずんだモンさんの画像をダウンロードしました。<br><a href="https://zunko.jp/" target="_blank" rel="noopener noreferrer">https://zunko.jp/</a></p><p><img loading="lazy" src="https://zunko.jp/images/chara_zm.png" width="214" height="302" data-is-external-image="true"></p><p>こんな感じになりました。</p><pre><code>&gt; python run.py --model wd-v1-4-moat-tagger.v2 --file chara_zm.png</code><br><code>solo, green_footwear, short_sleeves, green_hair, suspenders, shirt, white_shirt, green_shorts, suspender_shorts, shorts, white_background, full_body, 1girl, smile, simple_background, open_mouth, puffy_sleeves, looking_at_viewer, puffy_short_sleeves, standing, short_hair, puffy_shorts, orange_eyes, yellow_eyes, :d, hair_between_eyes, boots</code></pre><p><a href="#INTERNAL_LINK#/post/null"></a>単体で使うことができました。</p><h2>一気に画像にタグ付けをする</h2><p>多くの場合一枚一枚画像にタグ付けせずに一気に複数枚画像にタグ付けすると思います。<br>このコマンドではディレクトリを指定すると一括推論を行って画像ごとにキャプションファイルを作成します。</p><p>下記の例ではgazou_fileディレクトリ内の画像すべてに対してタグの予想をおこなって画像ファイル名 + ext(拡張子)でキャプションファイルを作っています。</p><pre><code>python3 run.py --dir ./gazou_file --ext .txt</code></pre><h2>推論モデルの変更方法</h2><p>コマンドのオプションから推論モデルを変更することができます。</p><pre class="notranslate"><code>python run.py --file image.jpg --model wd14-vit.v1
python run.py --file image.jpg --model wd14-vit.v2
python run.py --file image.jpg --model wd14-convnext.v1
python run.py --file image.jpg --model wd14-convnext.v2
python run.py --file image.jpg --model wd14-convnextv2.v1
python run.py --file image.jpg --model wd14-swinv2-v1
python run.py --file image.jpg --model wd-v1-4-moat-tagger.v2
python run.py --file image.jpg --model wd-v1-4-vit-tagger.v3
python run.py --file image.jpg --model wd-v1-4-convnext-tagger.v3
python run.py --file image.jpg --model wd-v1-4-swinv2-tagger.v3
python run.py --file image.jpg --model mld-caformer.dec-5-97527
python run.py --file image.jpg --model mld-tresnetd.6-30000</code></pre><p>推論モデルはいくつか存在してそれぞれのモデルで特色があります。</p><h4>wd14-swinv2系</h4><p>SmilingWolfさんが作成したモデルで、SwinTransformerと呼ばれる機械学習の手法で作られています。<br>SwinTransformerは後述のVisionTransformerに比べて新しい手法です</p><p>SmilingWolfさんのモデルの中ではmoatと並んで新しめのモデルで<strong>おすすめです</strong>。</p><h4>wd-v1-4-moat-tagger系</h4><p>SmilingWolfさんが作成したモデルで、MObile convolution and ATtention（moat）という機械学習の手法で作られたモデルです。<br>Transformer系は大量の学習データが無いと精度が上がりづらいので、比較的少数の画像で学習するCNN系の手法をTransformerに応用する流れの一つのようです。</p><p>SmilingWolfさんのモデルの中ではmoatと並んで新しめのモデルで<strong>おすすめです</strong>。<br>こちらの<a href="https://note.com/den2_nova/n/ndd9e2570572b">サイト</a>が参考になります。</p><h4>mld系</h4><p>通常使われるSmilingWolfさんのモデルとは違いkiriyamaXさんが作成したモデルです（ml-danbooruと呼ばれている？）。</p><p>細かく絵の要素を読み取ろうとしてくれるので、学習したいものによってはこっちのほうが向いているかもしれないです。<br>ただ、細かく絵の要素を読み取ろうとするためか誤りも多い印象です。</p><p>少し各タグの確率が高くつく傾向があるので足切り（スレッショルド）を上げたほうが良いです。</p><pre>python run.py --file image.jpg --model mld-caformer.dec-5-97527 --threshold 0.5<br>python run.py --file image.jpg --model mld-tresnetd.6-30000 --threshold 0.5</pre><p>リポジトリです。<br><a href="https://huggingface.co/kiriyamaX/mld-caformer">kiriyamaX/mld-caformer</a></p><h4>wd14-convnext系</h4><p>SmilingWolfさんが作成したモデルで、CNN系の推論モデルです。</p><p>CNNは画像を認識するモデルの中では昔から存在する一番標準的な手法でTransformerに比べると見劣りがする手法のように見えますが、ConvNextは新し目の手法でかなり精度が高いことが知られています。</p><h4>wd14-vit系</h4><p>SmilingWolfさんが作成したモデルで、VisionTransformer（Vit）系のモデルです。<br>機械学習の分野ではTransformerはCNNに比べて成果が上がっている手法ですがtaggerではそこまですごい差は無いように見えます。</p><p>マネキンと人間を見分ける精度が良いので個人的によく使っています。</p><h2>その他</h2><h3>タグの足切り</h3><p>taggerでは画像に対してすべてのタグの一致率を出して確率の高い物だけを残すようになっています。<br>確率が高いと判断するタグの足切りラインをthresholdオプションで決めることができます。</p><p>デフォルトではwebuiと同じく一律35%以上の一致率のタグだけを残しています。<br>これはコマンドライン引数で変更することができます。</p><div><pre># 25%に変更<br>python3 run.py --threshold 0.25 --file image.jpg</pre></div><h3>高速化</h3><p>NVIDIAのGPUを使用していて新し目のCUDAとcuDNNを使用している場合はGPUで推論することができます。</p><p>下記のようなコマンドでgpuに対応したライブラリをインストールします。</p><pre class="language-bash"><code>pip install onnxruntime-gpu --extra-index-url https://aiinfra.pkgs.visualstudio.com/PublicPackages/_packaging/onnxruntime-cuda-12/pypi/simple/</code></pre><p><a href="https://onnxruntime.ai/docs/install/" rel="nofollow">https://onnxruntime.ai/docs/install/</a><br><a href="https://onnxruntime.ai/docs/execution-providers/CUDA-ExecutionProvider.html#requirements" rel="nofollow">https://onnxruntime.ai/docs/execution-providers/CUDA-ExecutionProvider.html#requirements</a></p><p> </p></div><div class="modified-time">更新日: <time datetime="2024-07-09T13:26">2024-07-09</time></div><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fcorkborg.github.io%2Fwd14-tagger-standalone%2F" class="js-share facebook" title="Share with Facebook" rel="nofollow noopener noreferrer" aria-label="Share with Facebook"><svg class="u-icon"><use xlink:href="https://corkborg.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fcorkborg.github.io%2Fwd14-tagger-standalone%2F&amp;via=%E5%A1%A9%E3%81%AE%E6%83%91%E6%98%9F&amp;text=%E7%94%BB%E5%83%8F%E3%81%AB%E3%82%BF%E3%82%B0%E4%BB%98%E3%81%91%E3%81%99%E3%82%8BWD14%20tagger%E3%82%92webui%E7%84%A1%E3%81%97%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99" class="js-share twitter" title="Share with Twitter" rel="nofollow noopener noreferrer" target="_blank" aria-label="Share with Twitter"><svg class="u-icon"><use xlink:href="https://corkborg.github.io/assets/svg/svg-map.svg#twitter"/></svg></a></div><nav id="post-navigation"><div class="post-navigation-link"><a href="https://corkborg.github.io/steam-games-support-apple-silicon/" rel="prev">&larr; 前の記事: Apple Silicon Macで遊べるゲームリスト. M1 Macで検証してみた</a></div><div class="post-navigation-link"><a href="https://corkborg.github.io/salvia-maru-difference-3f-4f/" rel="next">次の記事: 伊豆大島 さるびあ丸 特2等室の3F、4Fの違いについて &rarr;</a></div></nav></article></main><aside><section><h3>Featured posts</h3><ol class="featured-posts__list"><li><a href="https://corkborg.github.io/richoh-wg-6-on-40m-dive/" class="invert">水深20mまでのRICOH WG-6を40m級のダイビングで使うとどうなるか？</a></li><li><a href="https://corkborg.github.io/raising-ants-less-interesting/" class="invert">アリの飼育は思ったよりも面白くなかった</a></li><li><a href="https://corkborg.github.io/created-kanji-to-time/" class="invert">日本語や漢字の日付をPythonのdatetimeに変換するライブラリを作った</a></li><li><a href="https://corkborg.github.io/publii-is-good-website-generator/" class="invert">使いやすいエディターで静的サイト運営できるPubliiがおすすめな話</a></li><li><a href="https://corkborg.github.io/energy-saving-battle-gaming-pc-vs-apple-silicon-mac/" class="invert">ゲーミングPCは電気代が高い！電気代が安いApple Silicon Macのゲームでの省電力能力を検証</a></li></ol></section></aside></div><footer><nav class="menu-navbar"><div class="menu"><div><a href="https://corkborg.github.io/contact/" target="_self">問い合わせ</a></div></div></nav><div id="footer-lower"><div></div><a class="main-logo" href="https://corkborg.github.io/"><img src="https://corkborg.github.io/media/website/logo2.png" alt="塩の惑星" height="80px"></a><div></div></div></footer><script defer="defer" src="https://corkborg.github.io/assets/js/prism.js?v=2730b884bcd782a7b6ffd13dcb5504c0"></script><script async src="https://corkborg.github.io/assets/js/scripts.js?v=3733efd39cd6c799b95c8fcb96993840"></script></body></html>